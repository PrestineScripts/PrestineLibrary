local PrestineManager = {}

local Players = game:GetService("Players")
local TweenService = game:GetService("TweenService")
local PathfindingService = game:GetService("PathfindingService")
local RunService = game:GetService("RunService")

local player = Players.LocalPlayer

PrestineManager.Config = {
	TravelMethod = "Teleport",
	TweenSpeed = 150,
	TeleportDelay = 0
}

PrestineManager.Profiles = {
	Default = {
		TravelMethod = "Teleport",
		TweenSpeed = 150,
		TeleportDelay = 0
	}
}

PrestineManager.State = {
	Busy = false,
	CurrentTask = "Idle"
}

PrestineManager._token = 0
PrestineManager._queue = {}
PrestineManager._activeTween = nil
PrestineManager._uiConn = nil
PrestineManager._charConn = nil
PrestineManager._deathConn = nil

PrestineManager._statusParagraph = nil
PrestineManager._statusSupportsUpdate = nil
PrestineManager._lastStatusText = ""
PrestineManager._lastStatusWarned = false

PrestineManager._lastServerUpdate = 0
PrestineManager._lastPerfUpdate = 0
PrestineManager._fps = 0
PrestineManager._fpsFrames = 0
PrestineManager._fpsLast = os.clock()

local function getCharacter()
	return player.Character or player.CharacterAdded:Wait()
end

local function getHumanoidRoot()
	local c = getCharacter()
	return c:WaitForChild("Humanoid"), c:WaitForChild("HumanoidRootPart")
end

local function toCFrame(target)
	if typeof(target) == "CFrame" then
		return target
	elseif typeof(target) == "Vector3" then
		return CFrame.new(target)
	elseif typeof(target) == "Instance" and target:IsA("BasePart") then
		return target.CFrame
	end
end

local function isValidMethod(m)
	return m == "Teleport"
		or m == "Tween"
		or m == "Walking"
		or m == "Hybrid"
		or m == "PathTween"
		or m == "Velocity"
		or m == "DropTeleport"
		or m == "MicroWalk"
end

local function setClipboard(text)
	if setclipboard then
		local ok = pcall(function() setclipboard(text) end)
		return ok
	elseif toclipboard then
		local ok = pcall(function() toclipboard(text) end)
		return ok
	end
	return false
end

local function clampNumber(v, lo, hi)
	local n = tonumber(v)
	if not n then return nil end
	return math.clamp(n, lo, hi)
end

function PrestineManager:ApplyProfile(name)
	local p = self.Profiles[name]
	if not p then return end
	for k, v in pairs(p) do
		self.Config[k] = v
	end
	if not isValidMethod(self.Config.TravelMethod) then
		self.Config.TravelMethod = "Teleport"
	end
end

function PrestineManager:SetConfig(k, v)
	if self.Config[k] == nil then return end
	self.Config[k] = v
	if k == "TravelMethod" and not isValidMethod(self.Config.TravelMethod) then
		self.Config.TravelMethod = "Teleport"
	end
end

function PrestineManager:Cancel()
	self._token += 1
	self._queue = {}
	self.State.Busy = false
	self.State.CurrentTask = "Cancelled"
	if self._activeTween then pcall(function() self._activeTween:Cancel() end) end
	self._activeTween = nil
end

function PrestineManager:Enqueue(target)
	table.insert(self._queue, target)
end

function PrestineManager:ClearQueue()
	self._queue = {}
end

local function teleportTo(hrp, cf)
	hrp.CFrame = cf
end

local function dropTeleport(hrp, cf)
	hrp.CFrame = cf + Vector3.new(0, 150, 0)
end

local function velocityTravel(hrp, cf)
	local bv = Instance.new("BodyVelocity")
	bv.MaxForce = Vector3.new(1e9, 1e9, 1e9)
	bv.Velocity = (cf.Position - hrp.Position).Unit * 80
	bv.Parent = hrp
	task.wait(0.5)
	bv:Destroy()
end

local function microWalk(hum, hrp, cf)
	while (hrp.Position - cf.Position).Magnitude > 2 do
		hum:MoveTo(hrp.Position:Lerp(cf.Position, 0.15))
		task.wait(0.15)
	end
end

local function tweenTo(hrp, cf, speed)
	local dist = (hrp.Position - cf.Position).Magnitude
	local dur = dist / speed

	local tween = TweenService:Create(
		hrp,
		TweenInfo.new(dur, Enum.EasingStyle.Quad, Enum.EasingDirection.Out),
		{ CFrame = cf }
	)
	tween:Play()
	tween.Completed:Wait()
end

local function pathTween(hum, hrp, cf, speed)
	local path = PathfindingService:CreatePath()
	path:ComputeAsync(hrp.Position, cf.Position)
	if path.Status ~= Enum.PathStatus.Success then return false end

	for _, wp in ipairs(path:GetWaypoints()) do
		if wp.Action == Enum.PathWaypointAction.Jump then
			hum:ChangeState(Enum.HumanoidStateType.Jumping)
		end
		tweenTo(hrp, CFrame.new(wp.Position), speed)
	end

	return true
end

function PrestineManager:_travel(cf, token)
	local hum, hrp = getHumanoidRoot()
	if not hum or not hrp then return end

	local method = self.Config.TravelMethod
	if not isValidMethod(method) then
		method = "Teleport"
		self.Config.TravelMethod = method
	end

	local function cancelled()
		return token ~= self._token
	end

	local function teleport()
		hrp.CFrame = cf
	end

	local function dropTeleport()
		hrp.CFrame = cf + Vector3.new(0, 150, 0)
	end

	local function tween(speed)
		local dist = (hrp.Position - cf.Position).Magnitude
		local dur = dist / math.max(speed, 1)

		local tween = TweenService:Create(
			hrp,
			TweenInfo.new(dur, Enum.EasingStyle.Quad, Enum.EasingDirection.Out),
			{ CFrame = cf }
		)

		self._activeTween = tween
		tween:Play()

		local lastPos = hrp.Position
		local lastMove = os.clock()

		while tween.PlaybackState == Enum.PlaybackState.Playing do
			if cancelled() then
				pcall(function() tween:Cancel() end)
				break
			end

			if (hrp.Position - lastPos).Magnitude > 0.15 then
				lastPos = hrp.Position
				lastMove = os.clock()
			elseif os.clock() - lastMove > 1 then
				pcall(function() tween:Cancel() end)
				break
			end

			task.wait(0.05)
		end

		self._activeTween = nil
	end

	local function microWalk()
		while not cancelled() and (hrp.Position - cf.Position).Magnitude > 2 do
			hum:MoveTo(hrp.Position:Lerp(cf.Position, 0.15))
			task.wait(0.15)
		end
	end

	local function velocityMove()
		local dir = (cf.Position - hrp.Position)
		if dir.Magnitude < 1 then return end

		local bv = Instance.new("BodyVelocity")
		bv.MaxForce = Vector3.new(1e9, 1e9, 1e9)
		bv.Velocity = dir.Unit * 80
		bv.Parent = hrp

		local t0 = os.clock()
		while not cancelled() and os.clock() - t0 < 0.6 do
			task.wait()
		end

		bv:Destroy()
	end

	local function pathTween()
		local path = PathfindingService:CreatePath()
		path:ComputeAsync(hrp.Position, cf.Position)
		if path.Status ~= Enum.PathStatus.Success then
			return false
		end

		for _, wp in ipairs(path:GetWaypoints()) do
			if cancelled() then return true end

			if wp.Action == Enum.PathWaypointAction.Jump then
				hum:ChangeState(Enum.HumanoidStateType.Jumping)
			end

			tween(self.Config.TweenSpeed)
		end

		return true
	end

	local dist = (hrp.Position - cf.Position).Magnitude

	-- =========================
	-- METHOD DISPATCH
	-- =========================

	if method == "Teleport" then
		teleport()
		task.wait(self.Config.TeleportDelay or 0)
		return
	end

	if method == "DropTeleport" then
		dropTeleport()
		return
	end

	if method == "Tween" then
		tween(self.Config.TweenSpeed)
		return
	end

	if method == "Hybrid" then
		if dist > 250 then
			teleport()
		else
			tween(self.Config.TweenSpeed)
		end
		return
	end

	if method == "PathTween" then
		if not pathTween() then
			teleport()
		end
		return
	end

	if method == "Velocity" then
		velocityMove()
		return
	end

	if method == "MicroWalk" then
		microWalk()
		return
	end

	if method == "Walking" then
		hum:MoveTo(cf.Position)
		hum.MoveToFinished:Wait(3)
		return
	end
end

function PrestineManager:StartQueue()
	if self.State.Busy then return end
	self.State.Busy = true
	self.State.CurrentTask = "Running"

	task.spawn(function()
		self._token += 1
		local token = self._token

		while #self._queue > 0 and token == self._token do
			local target = table.remove(self._queue, 1)
			local cf = toCFrame(target)
			if cf then
				self:_travel(cf, token)
			end
		end

		if token == self._token then
			self.State.Busy = false
			self.State.CurrentTask = "Idle"
		end
	end)
end

function PrestineManager:Travel(target)
	self:Cancel()
	self:Enqueue(target)
	self:StartQueue()
end

function PrestineManager:TravelMultiple(list)
	self:Cancel()
	for _, t in ipairs(list) do
		self:Enqueue(t)
	end
	self:StartQueue()
end

function PrestineManager:_trySetParagraphContent(paragraphObj, text)
	if not paragraphObj then return false end
	local candidates = { "SetContent", "SetText", "Update", "Set", "SetValue" }
	for _, m in ipairs(candidates) do
		local f = paragraphObj[m]
		if typeof(f) == "function" then
			local ok = pcall(function()
				f(paragraphObj, text)
			end)
			if ok then return true end
		end
	end
	return false
end

function PrestineManager:_notify(lib, title, content, dur)
	if not lib then return end
	pcall(function()
		lib:AddNotification({
			TitleText = title,
			ContentText = content,
			Duration = dur or 2
		})
	end)
end

function PrestineManager:_bindCharacterSafety()
	if self._charConn then self._charConn:Disconnect() end
	self._charConn = player.CharacterAdded:Connect(function()
		self:Cancel()
		self.State.CurrentTask = "Respawned"
	end)

	local hum = nil
	pcall(function()
		hum = getCharacter():FindFirstChildOfClass("Humanoid")
	end)

	if self._deathConn then self._deathConn:Disconnect() end
	if hum then
		self._deathConn = hum.Died:Connect(function()
			self:Cancel()
			self.State.CurrentTask = "Died"
		end)
	end
end

local MarketplaceService = game:GetService("MarketplaceService")

local function getServerInfoText()
	local serverType =
		game.PrivateServerId ~= "" and
		(game.PrivateServerOwnerId ~= 0 and "Private" or "Reserved") or
		"Public"

	return
		"Game Name: " .. game.Name ..
		"\nPlace ID: " .. game.PlaceId ..
		"\nGame ID: " .. game.GameId ..
		"\nServer ID: " .. (game.JobId ~= "" and game.JobId or "N/A") ..
		"\nServer Type: " .. serverType ..
		"\nPlayers: " .. #Players:GetPlayers() .. "/" .. Players.MaxPlayers ..
		"\nUptime: " .. math.floor(workspace:GetServerTimeNow()) .. "s" ..
		"\nStreaming Enabled: " .. tostring(workspace.StreamingEnabled) ..
		"\nGravity: " .. tostring(workspace.Gravity)
end

local function getPerformanceText(self)
	return
		"FPS: " .. tostring(self._fps) ..
		"\nPing: " .. math.floor(player:GetNetworkPing() * 1000) .. " ms"
end

local function getExtraCharacterInfo(hum, hrp)
	return
		"State: " .. hum:GetState().Name ..
		"\nRoot Anchored: " .. tostring(hrp.Anchored)
end

function PrestineManager:SetUpStarterUI()
	local PrestineLib = getgenv().PrestineLib
	if not PrestineLib then return end

	self:_bindCharacterSafety()

	PrestineLib:AddSection({ Tab = "Home", MainTitle = "Home" })

	PrestineLib:AddButton({
		Tab = "Home",
		MainName = "Copy YouTube",
		Callback = function()
			local ok = setClipboard("https://www.youtube.com/@PrestineScripts")
			if ok then
				self:_notify(PrestineLib, "Copied", "YouTube link copied to clipboard.", 2)
			else
				self:_notify(PrestineLib, "Unsupported", "Clipboard not supported in this environment.", 3)
			end
		end
	})

	PrestineLib:AddButton({
		Tab = "Home",
		MainName = "Copy Discord",
		Callback = function()
			local ok = setClipboard("https://discord.com/invite/AEmYSz6g4C")
			if ok then
				self:_notify(PrestineLib, "Copied", "Discord invite copied to clipboard.", 2)
			else
				self:_notify(PrestineLib, "Unsupported", "Clipboard not supported in this environment.", 3)
			end
		end
	})

	self._statusParagraph = PrestineLib:AddParagraph({
		Tab = "Home",
		MainTitle = "Character Status",
		paragraphSize = 140,
		MainContent = "Loading..."
	})

	self._serverStatusParagraph = PrestineLib:AddParagraph({
		Tab = "Home",
		MainTitle = "Server Info",
		paragraphSize = 160,
		MainContent = "Loading..."
	})
	
	self._perfParagraph = PrestineLib:AddParagraph({
		Tab = "Home",
		MainTitle = "Performance",
		paragraphSize = 90,
		MainContent = "Loading..."
	})

	PrestineLib:AddButton({
		Tab = "Home",
		MainName = "Clear Queue",
		Callback = function()
			self:ClearQueue()
			self:_notify(PrestineLib, "Queue", "Queue cleared.", 2)
		end
	})

	PrestineLib:AddButton({
		Tab = "Home",
		MainName = "Cancel Movement",
		Callback = function()
			self:Cancel()
			self:_notify(PrestineLib, "Cancelled", "Movement cancelled.", 2)
		end
	})

	PrestineLib:AddSection({ Tab = "Settings", MainTitle = "Movement" })

	PrestineLib:AddDropdown({
		Tab = "Settings",
		MainTitle = "Travel Method",
		ChoiceList = {
	"Teleport",
	"Tween",
	"Walking",
	"Hybrid",
	"PathTween",
	"Velocity",
	"DropTeleport",
	"MicroWalk"
},
		Multiple = false,
		DefaultChoice = { self.Config.TravelMethod },
		Callback = function(v)
			local m = typeof(v) == "table" and v[1] or v
			if not isValidMethod(m) then m = "Teleport" end
			self.Config.TravelMethod = m
			self:_notify(PrestineLib, "Updated", "Travel Method: " .. m, 2)
		end
	})

	PrestineLib:AddSlider({
		Tab = "Settings",
		SliderTitle = "Tween Speed",
		Min = 50,
		Max = 600,
		DefaultValue = self.Config.TweenSpeed,
		Increment = 10,
		Callback = function(v)
			self.Config.TweenSpeed = v
		end
	})

	PrestineLib:AddInput({
		Tab = "Settings",
		MainTitle = "Teleport Delay",
		PlaceHolder = "Seconds (0 - 10)",
		Callback = function(v)
			local n = clampNumber(v, 0, 10)
			if n ~= nil then
				self.Config.TeleportDelay = n
			end
		end
	})

	PrestineLib:AddSaveToggle({
	    Tab = "Settings",
	    MainName = "Auto Save Config",
	    DefaultState = true
	})

	if self._uiConn then self._uiConn:Disconnect() end

self._uiConn = RunService.Heartbeat:Connect(function()
	local char = player.Character
	if not char then return end

	local hum = char:FindFirstChildOfClass("Humanoid")
	local hrp = char:FindFirstChild("HumanoidRootPart")
	if not hum then return end

	local ws = hum.WalkSpeed
	local jp = hum.UseJumpPower and hum.JumpPower or hum.JumpHeight
	local hp = hum.Health
	local mhp = hum.MaxHealth

	local statusText =
		"Task: " .. tostring(self.State.CurrentTask) ..
		"\nQueue: " .. #self._queue ..
		"\nMethod: " .. self.Config.TravelMethod ..
		"\nTweenSpeed: " .. self.Config.TweenSpeed ..
		"\nTeleportDelay: " .. self.Config.TeleportDelay ..
		"\nWalkSpeed: " .. ws ..
		"\nJump: " .. jp ..
		"\nHealth: " .. string.format("%.0f/%.0f", hp, mhp)

	if hrp then
		statusText ..=
			"\nState: " .. hum:GetState().Name ..
			"\nRoot Anchored: " .. tostring(hrp.Anchored)
	end

	if statusText ~= self._lastStatusText then
		self._lastStatusText = statusText
		local ok = self:_trySetParagraphContent(self._statusParagraph, statusText)
		if not ok and not self._lastStatusWarned then
			self._lastStatusWarned = true
			self:_notify(
				PrestineLib,
				"Notice",
				"Status paragraph cannot be updated by this PrestineLib build.",
				4
			)
		end
	end

	if os.clock() - self._lastServerUpdate >= 1 then
		self._lastServerUpdate = os.clock()
		if self._serverStatusParagraph then
			self:_trySetParagraphContent(
				self._serverStatusParagraph,
				getServerInfoText()
			)
		end
	end

	if os.clock() - self._lastPerfUpdate >= 0.5 then
		self._lastPerfUpdate = os.clock()
		if self._perfParagraph then
			self:_trySetParagraphContent(
				self._perfParagraph,
				getPerformanceText(self)
			)
		end
	end
end)

RunService.RenderStepped:Connect(function()
	PrestineManager._fpsFrames += 1
	if os.clock() - PrestineManager._fpsLast >= 1 then
		PrestineManager._fps = PrestineManager._fpsFrames
		PrestineManager._fpsFrames = 0
		PrestineManager._fpsLast = os.clock()
	end
end)

return PrestineManager
