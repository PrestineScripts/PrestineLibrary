--// PrestineManager (Home + Settings only, Quick Panel removed)

local PrestineManager = {}

local Players = game:GetService("Players")
local TweenService = game:GetService("TweenService")
local PathfindingService = game:GetService("PathfindingService")
local RunService = game:GetService("RunService")

local player = Players.LocalPlayer

PrestineManager.Config = {
	TravelMethod = "Teleport",
	TweenSpeed = 150,
	TeleportDelay = 0,
}

PrestineManager.Profiles = {
	Default = {
		TravelMethod = "Teleport",
		TweenSpeed = 150,
		TeleportDelay = 0
	}
}

PrestineManager.State = {
	Busy = false,
	CurrentTask = "Idle"
}

PrestineManager._token = 0
PrestineManager._queue = {}
PrestineManager._activeTween = nil
PrestineManager._conn = nil
PrestineManager._uiConn = nil

--========================
-- Helpers
--========================
local function getCharacter()
	return player.Character or player.CharacterAdded:Wait()
end

local function getHumanoidRoot()
	local c = getCharacter()
	return c:WaitForChild("Humanoid"), c:WaitForChild("HumanoidRootPart")
end

local function toCFrame(target)
	if typeof(target) == "CFrame" then
		return target
	elseif typeof(target) == "Vector3" then
		return CFrame.new(target)
	elseif typeof(target) == "Instance" and target:IsA("BasePart") then
		return target.CFrame
	end
end

local function safeNum(v)
	return tonumber(v)
end

local function setClipboard(text)
	-- Works in most executors; harmless if unsupported
	if setclipboard then
		pcall(function() setclipboard(text) end)
	elseif toclipboard then
		pcall(function() toclipboard(text) end)
	end
end

--========================
-- Config
--========================
function PrestineManager:ApplyProfile(name)
	local p = self.Profiles[name]
	if not p then return end
	for k, v in pairs(p) do
		self.Config[k] = v
	end
end

function PrestineManager:SetConfig(k, v)
	if self.Config[k] ~= nil then
		self.Config[k] = v
	end
end

--========================
-- Control
--========================
function PrestineManager:Cancel()
	self._token += 1
	self._queue = {}
	self.State.Busy = false
	self.State.CurrentTask = "Cancelled"

	if self._activeTween then
		pcall(function() self._activeTween:Cancel() end)
	end
	if self._conn then
		self._conn:Disconnect()
	end

	self._activeTween = nil
	self._conn = nil
end

function PrestineManager:Enqueue(target)
	table.insert(self._queue, target)
end

function PrestineManager:ClearQueue()
	self._queue = {}
end

--========================
-- Movement
--========================
function PrestineManager:_travel(cf, token)
	local hum, hrp = getHumanoidRoot()
	local method = self.Config.TravelMethod

	if method == "Teleport" then
		hrp.CFrame = cf
		task.wait(self.Config.TeleportDelay)

	elseif method == "Tween" then
		local dist = (hrp.Position - cf.Position).Magnitude
		local dur = dist / math.max(self.Config.TweenSpeed, 1)

		local tween = TweenService:Create(
			hrp,
			TweenInfo.new(dur, Enum.EasingStyle.Quad, Enum.EasingDirection.Out),
			{ CFrame = cf }
		)

		self._activeTween = tween
		tween:Play()

		-- Token-aware wait
		local completed = false
		local c
		c = tween.Completed:Connect(function()
			completed = true
			if c then c:Disconnect() end
		end)

		while not completed do
			if token ~= self._token then
				pcall(function() tween:Cancel() end)
				break
			end
			task.wait()
		end

	elseif method == "Walking" then
		local path = PathfindingService:CreatePath()
		path:ComputeAsync(hrp.Position, cf.Position)

		if path.Status == Enum.PathStatus.Success then
			for _, wp in ipairs(path:GetWaypoints()) do
				if token ~= self._token then return end

				if wp.Action == Enum.PathWaypointAction.Jump then
					hum:ChangeState(Enum.HumanoidStateType.Jumping)
				end

				hum:MoveTo(wp.Position)
				hum.MoveToFinished:Wait()
			end
		end
	end
end

function PrestineManager:StartQueue()
	if self.State.Busy then return end
	self.State.Busy = true
	self.State.CurrentTask = "Running"

	task.spawn(function()
		self._token += 1
		local token = self._token

		while #self._queue > 0 and token == self._token do
			local target = table.remove(self._queue, 1)
			local cf = toCFrame(target)
			if cf then
				self:_travel(cf, token)
			end
		end

		self.State.Busy = false
		self.State.CurrentTask = "Idle"
	end)
end

function PrestineManager:Travel(target)
	self:Cancel()
	self:Enqueue(target)
	self:StartQueue()
end

function PrestineManager:TravelMultiple(list)
	self:Cancel()
	for _, t in ipairs(list) do
		self:Enqueue(t)
	end
	self:StartQueue()
end

--========================
-- UI (Home + Settings only)
--========================
function PrestineManager:SetUpStarterUI()
	local PrestineLib = getgenv().PrestineLib
	if not PrestineLib then return end

	-- HOME
	PrestineLib:AddSection({ Tab = "Home", MainTitle = "Home" })

	PrestineLib:AddButton({
		Tab = "Home",
		MainName = "Copy YouTube",
		Callback = function()
			setClipboard("YOUR_YOUTUBE_LINK_HERE")
			PrestineLib:AddNotification({
				TitleText = "Copied",
				ContentText = "YouTube link copied to clipboard.",
				Duration = 2
			})
		end
	})

	PrestineLib:AddButton({
		Tab = "Home",
		MainName = "Copy Discord",
		Callback = function()
			setClipboard("YOUR_DISCORD_INVITE_HERE")
			PrestineLib:AddNotification({
				TitleText = "Copied",
				ContentText = "Discord invite copied to clipboard.",
				Duration = 2
			})
		end
	})

	local status = PrestineLib:AddParagraph({
		Tab = "Home",
		MainTitle = "Character Status",
		paragraphSize = 120,
		MainContent = "Loading..."
	})

	-- SETTINGS
	PrestineLib:AddSection({ Tab = "Settings", MainTitle = "Movement Settings" })

	PrestineLib:AddDropdown({
		Tab = "Settings",
		MainTitle = "Travel Method",
		ChoiceList = { "Teleport", "Tween", "Walking" },
		Multiple = false,
		DefaultChoice = { self.Config.TravelMethod },
		Callback = function(v)
			self.Config.TravelMethod = typeof(v) == "table" and v[1] or v
		end
	})

	PrestineLib:AddSlider({
		Tab = "Settings",
		SliderTitle = "Tween Speed",
		Min = 50,
		Max = 600,
		DefaultValue = self.Config.TweenSpeed,
		Increment = 10,
		Callback = function(v)
			self.Config.TweenSpeed = v
		end
	})

	PrestineLib:AddInput({
		Tab = "Settings",
		MainTitle = "Teleport Delay",
		PlaceHolder = "Seconds (0 - 10)",
		Callback = function(v)
			local n = safeNum(v)
			if n then
				self.Config.TeleportDelay = math.clamp(n, 0, 10)
			end
		end
	})

	-- Live status updater
	if self._uiConn then
		self._uiConn:Disconnect()
	end

	self._uiConn = RunService.Heartbeat:Connect(function()
		local hum, _ = getHumanoidRoot()

		local ws = hum.WalkSpeed
		local jp = hum.UseJumpPower and hum.JumpPower or hum.JumpHeight
		local hp = hum.Health
		local mhp = hum.MaxHealth

		-- Only update if the paragraph object supports SetContent (prevents hard error)
		if status and status.SetContent then
			status:SetContent(
				"Task: " .. tostring(self.State.CurrentTask) ..
				"\nQueue: " .. tostring(#self._queue) ..
				"\nWalkSpeed: " .. tostring(ws) ..
				"\nJump: " .. tostring(jp) ..
				"\nHealth: " .. string.format("%.0f/%.0f", hp, mhp)
			)
		end
	end)
end

return PrestineManager
