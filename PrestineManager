local PrestineManager = {}

local Players = game:GetService("Players")
local TweenService = game:GetService("TweenService")
local PathfindingService = game:GetService("PathfindingService")
local RunService = game:GetService("RunService")

local player = Players.LocalPlayer

PrestineManager.Config = {
	TravelMethod = "Teleport",
	TweenSpeed = 150,
	TeleportDelay = 1,
	AutoFarm = false,
	AutoFarmInterval = 10,
	QuickPanel = true
}

PrestineManager._token = 0
PrestineManager._activeTween = nil
PrestineManager._activeConn = nil

local function getCharacter()
	local c = player.Character or player.CharacterAdded:Wait()
	return c
end

local function getHumanoidRoot()
	local c = getCharacter()
	return c:WaitForChild("Humanoid"), c:WaitForChild("HumanoidRootPart")
end

local function toCFrame(target)
	if typeof(target) == "CFrame" then
		return target
	elseif typeof(target) == "Vector3" then
		return CFrame.new(target)
	elseif typeof(target) == "Instance" and target:IsA("BasePart") then
		return target.CFrame
	end
end

function PrestineManager:SetConfig(key, value)
	if self.Config[key] ~= nil then
		self.Config[key] = value
	end
end

function PrestineManager:CancelTravel()
	self._token += 1
	if self._activeTween then
		pcall(function() self._activeTween:Cancel() end)
	end
	if self._activeConn then
		self._activeConn:Disconnect()
	end
	self._activeTween = nil
	self._activeConn = nil
end

function PrestineManager:TravelToTarget(target)
	self:CancelTravel()
	self._token += 1
	local token = self._token

	local cf = toCFrame(target)
	if not cf then return end

	local humanoid, hrp = getHumanoidRoot()
	local method = self.Config.TravelMethod

	if method == "Teleport" then
		hrp.CFrame = cf
		task.wait(self.Config.TeleportDelay)

	elseif method == "Tween" then
		local dist = (hrp.Position - cf.Position).Magnitude
		local duration = dist / math.max(self.Config.TweenSpeed, 1)

		local tween = TweenService:Create(
			hrp,
			TweenInfo.new(duration, Enum.EasingStyle.Quad, Enum.EasingDirection.Out),
			{ CFrame = cf }
		)

		self._activeTween = tween
		tween:Play()
		tween.Completed:Wait()

	elseif method == "Walking" then
		local path = PathfindingService:CreatePath()
		path:ComputeAsync(hrp.Position, cf.Position)
		if path.Status == Enum.PathStatus.Success then
			for _, wp in ipairs(path:GetWaypoints()) do
				if token ~= self._token then return end
				if wp.Action == Enum.PathWaypointAction.Jump then
					humanoid:ChangeState(Enum.HumanoidStateType.Jumping)
				end
				humanoid:MoveTo(wp.Position)
				humanoid.MoveToFinished:Wait()
			end
		end
	end
end

function PrestineManager:AutoFarmLoop()
	task.spawn(function()
		while true do
			if self.Config.AutoFarm then
				print("AutoFarm tick")
			end
			task.wait(self.Config.AutoFarmInterval)
		end
	end)
end

function PrestineManager:SetUpStarterUI()
	local PrestineLib = getgenv().PrestineLib
	if not PrestineLib then return end

	local humanoid = getHumanoidRoot()

	PrestineLib:AddSection({
		Tab = "Home",
		MainTitle = "Home"
	})

	local status = PrestineLib:AddParagraph({
		Tab = "Home",
		MainTitle = "Status",
		paragraphSize = 90,
		MainContent = "Loading..."
	})

	PrestineLib:AddButton({
		Tab = "Home",
		MainName = "Reset Character",
		Callback = function()
			PrestineLib:Confirm({
				Title = "Confirm",
				Content = "Reset your character?",
				Keybinds = true,
				Blur = true,
				OnConfirm = function()
					local hum = getHumanoidRoot()
					hum.Health = 0
				end
			})
		end
	})

	PrestineLib:AddTimedToggle({
		Tab = "Home",
		MainName = "Auto Farm",
		DefaultState = false,
		DefaultDuration = 10,
		DefaultUnit = "s",
		Mode = "AutoOff",
		Callback = function(v)
			self.Config.AutoFarm = v
		end
	})

	PrestineLib:AddSection({
		Tab = "Quick",
		MainTitle = "Quick Panel"
	})

	PrestineLib:AddToggle({
		Tab = "Quick",
		MainName = "Enable Auto Farm",
		DefaultState = false,
		Callback = function(v)
			self.Config.AutoFarm = v
		end
	})

	PrestineLib:AddKeybind({
		Tab = "Quick",
		MainTitle = "Toggle Auto Farm",
		DefaultKey = Enum.KeyCode.F,
		Callback = function()
			self.Config.AutoFarm = not self.Config.AutoFarm
		end
	})

	PrestineLib:AddSection({
		Tab = "Settings",
		MainTitle = "Movement"
	})

	PrestineLib:AddDropdown({
		Tab = "Settings",
		MainTitle = "Travel Method",
		ChoiceList = { "Teleport", "Tween", "Walking" },
		Multiple = false,
		DefaultChoice = { self.Config.TravelMethod },
		Callback = function(v)
			self.Config.TravelMethod = typeof(v) == "table" and v[1] or v
		end
	})

	PrestineLib:AddSlider({
		Tab = "Settings",
		SliderTitle = "Tween Speed",
		Min = 50,
		Max = 600,
		DefaultValue = self.Config.TweenSpeed,
		Increment = 10,
		Callback = function(v)
			self.Config.TweenSpeed = v
		end
	})

	PrestineLib:AddInput({
		Tab = "Settings",
		MainTitle = "Teleport Delay",
		PlaceHolder = "Seconds",
		Callback = function(v)
			local n = tonumber(v)
			if n then self.Config.TeleportDelay = math.clamp(n, 0, 10) end
		end
	})

	RunService.Heartbeat:Connect(function()
		local hum = player.Character and player.Character:FindFirstChildOfClass("Humanoid")
		status:SetContent(
			"Player: " .. player.Name ..
			"\nHealth: " .. (hum and math.floor(hum.Health) or 0) ..
			"\nAutoFarm: " .. tostring(self.Config.AutoFarm) ..
			"\nMethod: " .. self.Config.TravelMethod ..
			"\nTweenSpeed: " .. self.Config.TweenSpeed
		)
	end)
end

PrestineManager:AutoFarmLoop()

return PrestineManager
